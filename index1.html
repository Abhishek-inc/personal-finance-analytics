<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceHub â€” Firebase Firestore Edition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .auth-container {
            min-height: 100vh;
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
        .auth-box {
            background: white; border-radius: 20px; padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,.3);
            max-width: 450px; width: 100%;
            animation: slideUp .5s ease;
        }
        @keyframes slideUp {
            from { opacity:0; transform:translateY(30px); }
            to   { opacity:1; transform:translateY(0); }
        }
        .logo { text-align:center; margin-bottom:10px; }
        .logo h1 { color:#667eea; font-size:32px; margin-bottom:5px; }
        .logo p  { color:#666; font-size:14px; }

        .form-group { margin-bottom:20px; }
        .form-group label { display:block; margin-bottom:8px; color:#333; font-weight:500; }
        .form-group input {
            width:100%; padding:12px 15px;
            border:2px solid #e0e0e0; border-radius:10px;
            font-size:14px; transition:all .3s;
        }
        .form-group input:focus {
            outline:none; border-color:#667eea;
            box-shadow:0 0 0 3px rgba(102,126,234,.1);
        }

        .btn {
            width:100%; padding:14px; border:none; border-radius:10px;
            font-size:16px; font-weight:600; cursor:pointer; transition:all .3s;
        }
        .btn-primary {
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:white;
        }
        .btn-primary:hover { transform:translateY(-2px); box-shadow:0 10px 20px rgba(102,126,234,.3); }
        .btn-primary:disabled { opacity:.6; cursor:not-allowed; transform:none; }
        .btn-secondary { background:#f5f5f5; color:#666; margin-top:10px; }

        .alert { padding:12px 15px; border-radius:10px; margin-bottom:20px; font-size:14px; }
        .alert-success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
        .alert-error   { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
        .hidden { display:none !important; }

        /* â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .dashboard { display:none; max-width:1400px; margin:0 auto; padding:20px; }
        .dashboard.active { display:block; }

        .header {
            background:white; border-radius:15px; padding:20px 30px;
            margin-bottom:30px; box-shadow:0 5px 15px rgba(0,0,0,.1);
            display:flex; justify-content:space-between; align-items:center;
        }
        .header h1 { color:#333; font-size:24px; }
        .btn-logout {
            background:#f44336; color:white; padding:10px 20px;
            border:none; border-radius:8px; cursor:pointer; font-size:14px;
        }

        .stats-grid {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
            gap:20px; margin-bottom:30px;
        }
        .stat-card {
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:white; padding:25px; border-radius:15px;
            box-shadow:0 10px 20px rgba(102,126,234,.3);
        }
        .stat-card h3 { font-size:13px; opacity:.9; margin-bottom:10px; }
        .stat-card .value { font-size:28px; font-weight:700; }

        .card {
            background:white; border-radius:15px; padding:25px;
            margin-bottom:20px; box-shadow:0 5px 15px rgba(0,0,0,.1);
        }
        .card-header {
            font-size:20px; font-weight:600; color:#333;
            margin-bottom:20px; padding-bottom:15px;
            border-bottom:2px solid #f0f0f0;
        }

        .tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
        .tab {
            padding:10px 20px; background:white; border:2px solid #e0e0e0;
            border-radius:10px; cursor:pointer; transition:all .3s; font-size:14px;
        }
        .tab.active {
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:white; border-color:transparent;
        }
        .tab-content { display:none; }
        .tab-content.active { display:block; }

        .form-row {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
            gap:15px; margin-bottom:20px;
        }
        .loading { text-align:center; padding:40px; color:#666; font-size:15px; }

        /* data tables */
        table { width:100%; border-collapse:collapse; font-size:14px; }
        th { background:#667eea; color:white; padding:10px 12px; text-align:left; }
        td { padding:10px 12px; border-bottom:1px solid #f0f0f0; }
        tr:hover td { background:#fafafa; }

        .badge {
            display:inline-block; padding:3px 10px; border-radius:20px;
            font-size:12px; font-weight:600;
        }
        .badge-green  { background:#d4edda; color:#155724; }
        .badge-red    { background:#f8d7da; color:#721c24; }
        .badge-yellow { background:#fff3cd; color:#856404; }

        .action-btn {
            background:none; border:1px solid #ccc; padding:4px 10px;
            border-radius:6px; cursor:pointer; font-size:12px; margin:2px;
        }
        .action-btn:hover { background:#f0f0f0; }
        .action-btn.del { border-color:#f44336; color:#f44336; }
        .action-btn.del:hover { background:#fde0e0; }

        .info-box {
            background:#e3f2fd; border:1px solid #90caf9;
            border-radius:10px; padding:15px; margin-bottom:20px;
            font-size:13px; line-height:1.7; color:#1565c0;
        }
        .info-box strong { display:block; margin-bottom:4px; font-size:14px; }

        .section-label {
            font-size:13px; color:#888; font-weight:600;
            text-transform:uppercase; letter-spacing:.5px;
            margin-bottom:8px;
        }
        .metric-row {
            display:flex; justify-content:space-between;
            padding:8px 0; border-bottom:1px solid #f0f0f0; font-size:14px;
        }
        .metric-row:last-child { border-bottom:none; }
        .metric-val { font-weight:600; color:#667eea; }
    </style>
</head>
<body>

<!-- â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="authContainer" class="auth-container">
    <div class="auth-box">
        <div class="logo">
            <h1>ğŸ’° FinanceHub</h1>
            <p>Powered by Firebase Firestore</p>
        </div>
        <div id="alertBox"></div>

        <div id="loginForm">
            <div class="form-group"><label>Email</label>
                <input type="email" id="loginEmail" placeholder="you@example.com"></div>
            <div class="form-group"><label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password"></div>
            <button class="btn btn-primary" id="loginBtn" onclick="handleLogin()">Login</button>
            <button class="btn btn-secondary" onclick="toggleAuthForm()">Create New Account</button>
        </div>

        <div id="registerForm" class="hidden">
            <div class="form-group"><label>Full Name</label>
                <input type="text" id="registerName" placeholder="John Doe"></div>
            <div class="form-group"><label>Email</label>
                <input type="email" id="registerEmail" placeholder="you@example.com"></div>
            <div class="form-group"><label>Password</label>
                <input type="password" id="registerPassword" placeholder="Min 6 characters"></div>
            <button class="btn btn-primary" id="registerBtn" onclick="handleRegister()">Create Account</button>
            <button class="btn btn-secondary" onclick="toggleAuthForm()">Back to Login</button>
        </div>
    </div>
</div>

<!-- â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="dashboardContainer" class="dashboard">
    <div class="header">
        <h1>ğŸ“Š Financial Dashboard</h1>
        <div>
            <span id="userName" style="margin-right:20px;color:#666;font-size:14px;"></span>
            <button class="btn-logout" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <!-- Quick stats -->
    <div class="stats-grid">
        <div class="stat-card"><h3>Annual Income</h3><div class="value" id="statIncome">â‚¹0</div></div>
        <div class="stat-card"><h3>Avg Monthly Expense</h3><div class="value" id="statExpense">â‚¹0</div></div>
        <div class="stat-card"><h3>Total Savings</h3><div class="value" id="statSavings">â‚¹0</div></div>
        <div class="stat-card"><h3>Health Score</h3><div class="value" id="statHealth">â€”</div></div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('overview',this)">Overview</button>
        <button class="tab" onclick="switchTab('income',this)">Income</button>
        <button class="tab" onclick="switchTab('expenses',this)">Expenses</button>
        <button class="tab" onclick="switchTab('savings',this)">Savings</button>
        <button class="tab" onclick="switchTab('tax',this)">Tax</button>
        <button class="tab" onclick="switchTab('health',this)">Health</button>
    </div>

    <!-- â”€â”€ Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="overviewTab" class="tab-content active">
        <div class="info-box">
            <strong>ğŸ”¥ Firestore Live Database</strong>
            All data is saved directly to <strong>Cloud Firestore</strong> in real-time â€”
            no backend server needed. Each user's data is stored under
            <code>users/{uid}/</code> and protected by Security Rules so only
            they can read or write it.
        </div>
        <div class="card">
            <div class="card-header">Summary</div>
            <div id="overviewContent" class="loading">Loadingâ€¦</div>
        </div>
        <div class="card">
            <div class="card-header">Recent Expenses</div>
            <div id="recentExpenses" class="loading">Loadingâ€¦</div>
        </div>
    </div>

    <!-- â”€â”€ Income â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="incomeTab" class="tab-content">
        <div class="card">
            <div class="card-header">Add / Update Income</div>
            <div class="form-row">
                <div class="form-group"><label>Financial Year</label>
                    <input id="incYear" value="2024-25"></div>
                <div class="form-group"><label>Salary (â‚¹)</label>
                    <input type="number" id="salary" placeholder="800000"></div>
                <div class="form-group"><label>Bonus (â‚¹)</label>
                    <input type="number" id="bonus" value="0"></div>
                <div class="form-group"><label>Rental Income (â‚¹)</label>
                    <input type="number" id="rental" value="0"></div>
                <div class="form-group"><label>Capital Gains (â‚¹)</label>
                    <input type="number" id="capgains" value="0"></div>
                <div class="form-group"><label>Other Income (â‚¹)</label>
                    <input type="number" id="otherinc" value="0"></div>
            </div>
            <button class="btn btn-primary" style="max-width:220px" onclick="saveIncome()">ğŸ’¾ Save Income</button>
        </div>
        <div class="card">
            <div class="card-header">Tax Deductions</div>
            <div class="form-row">
                <div class="form-group"><label>Section 80C (â‚¹)</label>
                    <input type="number" id="d80c" value="0"></div>
                <div class="form-group"><label>Section 80D (â‚¹)</label>
                    <input type="number" id="d80d" value="0"></div>
                <div class="form-group"><label>Section 80G (â‚¹)</label>
                    <input type="number" id="d80g" value="0"></div>
                <div class="form-group"><label>Home Loan Interest (â‚¹)</label>
                    <input type="number" id="d24" value="0"></div>
                <div class="form-group"><label>NPS 80CCD (â‚¹)</label>
                    <input type="number" id="dnps" value="0"></div>
                <div class="form-group"><label>HRA Exemption (â‚¹)</label>
                    <input type="number" id="dhra" value="0"></div>
            </div>
            <button class="btn btn-primary" style="max-width:240px" onclick="saveDeductions()">ğŸ’¾ Save Deductions</button>
        </div>
        <div class="card">
            <div class="card-header">Saved Income Records</div>
            <div id="incomeTable" class="loading">Loadingâ€¦</div>
        </div>
    </div>

    <!-- â”€â”€ Expenses â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="expensesTab" class="tab-content">
        <div class="card">
            <div class="card-header">Add Monthly Expenses</div>
            <div class="form-row">
                <div class="form-group"><label>Month-Year (YYYY-MM)</label>
                    <input id="expMonth" placeholder="2024-12"></div>
                <div class="form-group"><label>Rent (â‚¹)</label>
                    <input type="number" id="eRent" value="0"></div>
                <div class="form-group"><label>Groceries (â‚¹)</label>
                    <input type="number" id="eGrocery" value="0"></div>
                <div class="form-group"><label>Utilities (â‚¹)</label>
                    <input type="number" id="eUtil" value="0"></div>
                <div class="form-group"><label>Transportation (â‚¹)</label>
                    <input type="number" id="eTrans" value="0"></div>
                <div class="form-group"><label>Entertainment (â‚¹)</label>
                    <input type="number" id="eEnt" value="0"></div>
                <div class="form-group"><label>Healthcare (â‚¹)</label>
                    <input type="number" id="eHealth" value="0"></div>
                <div class="form-group"><label>Education (â‚¹)</label>
                    <input type="number" id="eEdu" value="0"></div>
            </div>
            <button class="btn btn-primary" style="max-width:220px" onclick="saveExpense()">ğŸ’¾ Save Expenses</button>
        </div>
        <div class="card">
            <div class="card-header">Expense History</div>
            <div id="expenseTable" class="loading">Loadingâ€¦</div>
        </div>
    </div>

    <!-- â”€â”€ Savings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="savingsTab" class="tab-content">
        <div class="card">
            <div class="card-header">Add Monthly Savings</div>
            <div class="form-row">
                <div class="form-group"><label>Month-Year (YYYY-MM)</label>
                    <input id="savMonth" placeholder="2024-12"></div>
                <div class="form-group"><label>Fixed Deposits (â‚¹)</label>
                    <input type="number" id="sFD" value="0"></div>
                <div class="form-group"><label>Mutual Funds (â‚¹)</label>
                    <input type="number" id="sMF" value="0"></div>
                <div class="form-group"><label>PPF (â‚¹)</label>
                    <input type="number" id="sPPF" value="0"></div>
                <div class="form-group"><label>Stocks (â‚¹)</label>
                    <input type="number" id="sStocks" value="0"></div>
                <div class="form-group"><label>Gold (â‚¹)</label>
                    <input type="number" id="sGold" value="0"></div>
                <div class="form-group"><label>Emergency Fund (â‚¹)</label>
                    <input type="number" id="sEmerg" value="0"></div>
            </div>
            <button class="btn btn-primary" style="max-width:220px" onclick="saveSavings()">ğŸ’¾ Save Savings</button>
        </div>
        <div class="card">
            <div class="card-header">Savings History</div>
            <div id="savingsTable" class="loading">Loadingâ€¦</div>
        </div>
    </div>

    <!-- â”€â”€ Tax â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="taxTab" class="tab-content">
        <div class="card">
            <div class="card-header">Tax Calculator</div>
            <div class="form-group" style="max-width:250px">
                <label>Financial Year</label>
                <input id="taxYear" value="2024-25">
            </div>
            <button class="btn btn-primary" style="max-width:200px;margin-top:10px"
                    onclick="calculateTax()">Calculate Tax</button>
            <div id="taxResult" style="margin-top:25px;"></div>
        </div>
    </div>

    <!-- â”€â”€ Health â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="healthTab" class="tab-content">
        <div class="card">
            <div class="card-header">Financial Health Score</div>
            <button class="btn btn-primary" style="max-width:220px"
                    onclick="calcHealth()">Calculate Health Score</button>
            <div id="healthResult" style="margin-top:25px;"></div>
        </div>
    </div>
</div>

<!-- â•â•â• FIREBASE SDKs â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIREBASE CONFIG â€” replace with yours from Firebase Console
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const firebaseConfig = {
    apiKey:            "AIzaSyBEGOpuxZsbFLQIz8jxj5avVVGoz2ano_E",
    authDomain:        "project-2e9a4535-6825-484c-997.firebaseapp.com",
    projectId:         "project-2e9a4535-6825-484c-997",
    storageBucket:     "project-2e9a4535-6825-484c-997.firebasestorage.app",
    messagingSenderId: "398727607304",
    appId:             "1:398727607304:web:ed51a375fc80fd99accdbd"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();          // â† Firestore database instance

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATABASE SCHEMA (Firestore Collections)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Firestore path structure (all under the logged-in user's UID):

   users/{uid}/
   â”œâ”€â”€ profile          (document)  â† name, email, createdAt
   â”œâ”€â”€ income/{year}    (document)  â† salary, bonus, rental_income, â€¦
   â”œâ”€â”€ deductions/{year}(document)  â† section_80c, section_80d, â€¦
   â”œâ”€â”€ expenses/{month} (document)  â† rent, groceries, utilities, â€¦
   â””â”€â”€ savings/{month}  (document)  â† fixed_deposits, mutual_funds, â€¦
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

let currentUser = null;

/* â”€â”€ Firestore helper: returns the root ref for the current user â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function userRef()      { return db.collection('users').doc(currentUser.uid); }
function incomeRef(yr)  { return userRef().collection('income').doc(yr); }
function deductRef(yr)  { return userRef().collection('deductions').doc(yr); }
function expenseRef(mo) { return userRef().collection('expenses').doc(mo); }
function savingRef(mo)  { return userRef().collection('savings').doc(mo); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showAlert(msg, type='success') {
    const box = document.getElementById('alertBox');
    box.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    setTimeout(() => box.innerHTML='', 5000);
}
function toggleAuthForm() {
    document.getElementById('loginForm').classList.toggle('hidden');
    document.getElementById('registerForm').classList.toggle('hidden');
    document.getElementById('alertBox').innerHTML = '';
}
function setLoading(id, on) {
    const b = document.getElementById(id);
    if (b) { b.disabled = on; b.textContent = on ? 'Please waitâ€¦' : b.dataset.lbl || b.textContent; }
}
function fbErr(e) {
    const map = {
        'auth/email-already-in-use':'Email already registered.',
        'auth/invalid-email':'Invalid email address.',
        'auth/weak-password':'Password must be â‰¥ 6 characters.',
        'auth/user-not-found':'No account with this email.',
        'auth/wrong-password':'Incorrect password.',
        'auth/invalid-credential':'Email or password is incorrect.',
        'auth/too-many-requests':'Too many attempts. Try later.',
        'auth/network-request-failed':'Network error â€” check your connection.',
    };
    return map[e.code] || e.message;
}

/* â”€â”€ Register â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function handleRegister() {
    const name  = document.getElementById('registerName').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const pass  = document.getElementById('registerPassword').value;
    if (!name||!email||!pass) { showAlert('Fill in all fields.','error'); return; }
    if (pass.length < 6)      { showAlert('Password must be â‰¥ 6 chars.','error'); return; }

    setLoading('registerBtn', true);
    try {
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        await cred.user.updateProfile({ displayName: name });

        /* ğŸ”¥ Create user profile document in Firestore */
        await userRef().set({
            full_name:  name,
            email:      email,
            created_at: firebase.firestore.FieldValue.serverTimestamp(),
            updated_at: firebase.firestore.FieldValue.serverTimestamp()
        });
        showAlert('Account created! Logging you inâ€¦', 'success');
    } catch (e) { showAlert(fbErr(e), 'error'); }
    finally     { setLoading('registerBtn', false); }
}

/* â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function handleLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const pass  = document.getElementById('loginPassword').value;
    if (!email||!pass) { showAlert('Enter email and password.','error'); return; }

    setLoading('loginBtn', true);
    try {
        await auth.signInWithEmailAndPassword(email, pass);
    } catch (e) { showAlert(fbErr(e), 'error'); }
    finally     { setLoading('loginBtn', false); }
}

/* â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handleLogout() { auth.signOut(); }

/* â”€â”€ Auth state observer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
        document.getElementById('authContainer').style.display  = 'none';
        document.getElementById('dashboardContainer').classList.add('active');
        document.getElementById('userName').textContent = user.displayName || user.email;
        loadAllData();
    } else {
        document.getElementById('authContainer').style.display  = 'flex';
        document.getElementById('dashboardContainer').classList.remove('active');
    }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATABASE WRITE FUNCTIONS  (all save to Firestore)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Save Income â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function saveIncome() {
    const yr  = document.getElementById('incYear').value.trim() || '2024-25';
    const doc = {
        financial_year: yr,
        salary:         num('salary'),
        bonus:          num('bonus'),
        rental_income:  num('rental'),
        capital_gains:  num('capgains'),
        other_income:   num('otherinc'),
        total_income:   0,          // computed below
        updated_at:     firebase.firestore.FieldValue.serverTimestamp()
    };
    doc.total_income = doc.salary + doc.bonus + doc.rental_income
                     + doc.capital_gains + doc.other_income;

    try {
        /* set() with merge:true = create if missing, update if exists */
        await incomeRef(yr).set(doc, { merge: true });
        toast('âœ… Income saved!');
        loadAllData();
    } catch(e) { toast('âŒ Error: ' + e.message, true); }
}

/* â”€â”€ Save Deductions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function saveDeductions() {
    const yr  = document.getElementById('incYear').value.trim() || '2024-25';
    const doc = {
        financial_year: yr,
        section_80c:   num('d80c'),
        section_80d:   num('d80d'),
        section_80g:   num('d80g'),
        section_24:    num('d24'),
        nps_80ccd:     num('dnps'),
        hra_exemption: num('dhra'),
        updated_at:    firebase.firestore.FieldValue.serverTimestamp()
    };
    doc.total_deductions = doc.section_80c + doc.section_80d + doc.section_80g
                         + doc.section_24  + doc.nps_80ccd  + doc.hra_exemption;
    try {
        await deductRef(yr).set(doc, { merge: true });
        toast('âœ… Deductions saved!');
    } catch(e) { toast('âŒ Error: ' + e.message, true); }
}

/* â”€â”€ Save Expense â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function saveExpense() {
    const mo  = document.getElementById('expMonth').value.trim();
    if (!mo) { toast('Enter Month-Year (e.g. 2024-12)', true); return; }
    const doc = {
        month_year:     mo,
        rent:           num('eRent'),
        groceries:      num('eGrocery'),
        utilities:      num('eUtil'),
        transportation: num('eTrans'),
        entertainment:  num('eEnt'),
        healthcare:     num('eHealth'),
        education:      num('eEdu'),
        updated_at:     firebase.firestore.FieldValue.serverTimestamp()
    };
    doc.total_expenses = doc.rent + doc.groceries + doc.utilities
                       + doc.transportation + doc.entertainment
                       + doc.healthcare + doc.education;
    try {
        await expenseRef(mo).set(doc, { merge: true });
        toast('âœ… Expenses saved!');
        loadAllData();
    } catch(e) { toast('âŒ Error: ' + e.message, true); }
}

/* â”€â”€ Save Savings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function saveSavings() {
    const mo  = document.getElementById('savMonth').value.trim();
    if (!mo) { toast('Enter Month-Year (e.g. 2024-12)', true); return; }
    const doc = {
        month_year:      mo,
        fixed_deposits:  num('sFD'),
        mutual_funds:    num('sMF'),
        ppf:             num('sPPF'),
        stocks:          num('sStocks'),
        gold:            num('sGold'),
        emergency_fund:  num('sEmerg'),
        updated_at:      firebase.firestore.FieldValue.serverTimestamp()
    };
    doc.total_savings = doc.fixed_deposits + doc.mutual_funds + doc.ppf
                      + doc.stocks + doc.gold + doc.emergency_fund;
    try {
        await savingRef(mo).set(doc, { merge: true });
        toast('âœ… Savings saved!');
        loadAllData();
    } catch(e) { toast('âŒ Error: ' + e.message, true); }
}

/* â”€â”€ Delete helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function deleteExpense(mo) {
    if (!confirm(`Delete expense record for ${mo}?`)) return;
    try {
        await expenseRef(mo).delete();
        toast('ğŸ—‘ï¸ Deleted!'); loadAllData();
    } catch(e) { toast('âŒ ' + e.message, true); }
}
async function deleteSaving(mo) {
    if (!confirm(`Delete savings record for ${mo}?`)) return;
    try {
        await savingRef(mo).delete();
        toast('ğŸ—‘ï¸ Deleted!'); loadAllData();
    } catch(e) { toast('âŒ ' + e.message, true); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATABASE READ FUNCTIONS  (all read from Firestore)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadAllData() {
    await Promise.all([
        loadOverview(),
        loadIncomeTable(),
        loadExpenseTable(),
        loadSavingsTable()
    ]);
}

/* â”€â”€ Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadOverview() {
    try {
        /* Fetch latest income */
        const incSnap = await userRef().collection('income')
            .orderBy('financial_year','desc').limit(1).get();
        const inc = incSnap.empty ? null : incSnap.docs[0].data();

        /* Fetch all expenses (for avg) */
        const expSnap = await userRef().collection('expenses').get();
        const expenses = expSnap.docs.map(d => d.data());

        /* Fetch all savings (for total) */
        const savSnap = await userRef().collection('savings').get();
        const savings = savSnap.docs.map(d => d.data());

        /* Update stat cards */
        const totalInc = inc ? inc.total_income : 0;
        const avgExp   = expenses.length ? expenses.reduce((s,e)=>s+e.total_expenses,0)/expenses.length : 0;
        const totalSav = savings.reduce((s,sv)=>s+sv.total_savings,0);

        document.getElementById('statIncome').textContent  = fmt(totalInc);
        document.getElementById('statExpense').textContent = fmt(Math.round(avgExp));
        document.getElementById('statSavings').textContent = fmt(totalSav);

        /* Health score quick calc */
        let healthScore = 'â€”';
        if (totalInc > 0) {
            const savRatio = (totalSav / totalInc) * 100;
            const expRatio = (avgExp * 12 / totalInc) * 100;
            healthScore = Math.min(100, Math.max(0,
                Math.round((savRatio >= 20 ? 40 : savRatio*2) +
                           (expRatio <= 50 ? 40 : Math.max(0, 40-(expRatio-50))) +
                           20)
            ));
        }
        document.getElementById('statHealth').textContent = healthScore;

        /* Summary card */
        document.getElementById('overviewContent').innerHTML = inc ? `
            <div class="section-label">Latest Income Record</div>
            <div class="metric-row"><span>Financial Year</span><span class="metric-val">${inc.financial_year}</span></div>
            <div class="metric-row"><span>Salary</span><span class="metric-val">${fmt(inc.salary)}</span></div>
            <div class="metric-row"><span>Total Income</span><span class="metric-val">${fmt(inc.total_income)}</span></div>
            <div class="metric-row"><span>Expense Records</span><span class="metric-val">${expenses.length} months</span></div>
            <div class="metric-row"><span>Savings Records</span><span class="metric-val">${savings.length} months</span></div>
        ` : '<p style="color:#999;padding:20px 0;">No data yet. Go to <strong>Income</strong> tab to get started.</p>';

        /* Recent expenses table */
        const recent = expenses.sort((a,b)=>b.month_year.localeCompare(a.month_year)).slice(0,5);
        document.getElementById('recentExpenses').innerHTML = recent.length ? `
            <table>
                <tr><th>Month</th><th>Rent</th><th>Groceries</th><th>Utilities</th><th>Total</th></tr>
                ${recent.map(e=>`
                <tr>
                    <td>${e.month_year}</td>
                    <td>${fmt(e.rent)}</td>
                    <td>${fmt(e.groceries)}</td>
                    <td>${fmt(e.utilities)}</td>
                    <td><strong>${fmt(e.total_expenses)}</strong></td>
                </tr>`).join('')}
            </table>` : '<p style="color:#999;">No expense records yet.</p>';
    } catch(e) {
        document.getElementById('overviewContent').innerHTML =
            `<p style="color:#e53935;">Error loading data: ${e.message}</p>`;
    }
}

/* â”€â”€ Income Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadIncomeTable() {
    try {
        const snap = await userRef().collection('income').orderBy('financial_year','desc').get();
        if (snap.empty) {
            document.getElementById('incomeTable').innerHTML = '<p style="color:#999;">No income records yet.</p>';
            return;
        }
        document.getElementById('incomeTable').innerHTML = `
            <table>
                <tr><th>Year</th><th>Salary</th><th>Bonus</th><th>Other</th><th>Total</th></tr>
                ${snap.docs.map(d => {
                    const r = d.data();
                    return `<tr>
                        <td>${r.financial_year}</td>
                        <td>${fmt(r.salary)}</td>
                        <td>${fmt(r.bonus)}</td>
                        <td>${fmt((r.rental_income||0)+(r.capital_gains||0)+(r.other_income||0))}</td>
                        <td><strong>${fmt(r.total_income)}</strong></td>
                    </tr>`;
                }).join('')}
            </table>`;
    } catch(e) {
        document.getElementById('incomeTable').innerHTML = `<p style="color:#e53935;">${e.message}</p>`;
    }
}

/* â”€â”€ Expense Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadExpenseTable() {
    try {
        const snap = await userRef().collection('expenses').orderBy('month_year','desc').get();
        if (snap.empty) {
            document.getElementById('expenseTable').innerHTML = '<p style="color:#999;">No expense records yet.</p>';
            return;
        }
        document.getElementById('expenseTable').innerHTML = `
            <table>
                <tr><th>Month</th><th>Rent</th><th>Groceries</th><th>Utilities</th>
                    <th>Transport</th><th>Total</th><th>Action</th></tr>
                ${snap.docs.map(d => {
                    const r = d.data();
                    return `<tr>
                        <td>${r.month_year}</td>
                        <td>${fmt(r.rent)}</td>
                        <td>${fmt(r.groceries)}</td>
                        <td>${fmt(r.utilities)}</td>
                        <td>${fmt(r.transportation)}</td>
                        <td><strong>${fmt(r.total_expenses)}</strong></td>
                        <td><button class="action-btn del" onclick="deleteExpense('${r.month_year}')">ğŸ—‘ï¸ Del</button></td>
                    </tr>`;
                }).join('')}
            </table>`;
    } catch(e) {
        document.getElementById('expenseTable').innerHTML = `<p style="color:#e53935;">${e.message}</p>`;
    }
}

/* â”€â”€ Savings Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadSavingsTable() {
    try {
        const snap = await userRef().collection('savings').orderBy('month_year','desc').get();
        if (snap.empty) {
            document.getElementById('savingsTable').innerHTML = '<p style="color:#999;">No savings records yet.</p>';
            return;
        }
        document.getElementById('savingsTable').innerHTML = `
            <table>
                <tr><th>Month</th><th>FDs</th><th>Mutual Funds</th><th>PPF</th>
                    <th>Stocks</th><th>Total</th><th>Action</th></tr>
                ${snap.docs.map(d => {
                    const r = d.data();
                    return `<tr>
                        <td>${r.month_year}</td>
                        <td>${fmt(r.fixed_deposits)}</td>
                        <td>${fmt(r.mutual_funds)}</td>
                        <td>${fmt(r.ppf)}</td>
                        <td>${fmt(r.stocks)}</td>
                        <td><strong>${fmt(r.total_savings)}</strong></td>
                        <td><button class="action-btn del" onclick="deleteSaving('${r.month_year}')">ğŸ—‘ï¸ Del</button></td>
                    </tr>`;
                }).join('')}
            </table>`;
    } catch(e) {
        document.getElementById('savingsTable').innerHTML = `<p style="color:#e53935;">${e.message}</p>`;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAX CALCULATOR  (calculated locally from Firestore data)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function calculateTax() {
    const yr = document.getElementById('taxYear').value.trim() || '2024-25';
    const result = document.getElementById('taxResult');
    result.innerHTML = '<div class="loading">Fetching data from Firestoreâ€¦</div>';
    try {
        const [incSnap, dedSnap] = await Promise.all([
            incomeRef(yr).get(),
            deductRef(yr).get()
        ]);
        if (!incSnap.exists) {
            result.innerHTML = `<p style="color:#e53935;">No income data for ${yr}. Add it in the Income tab.</p>`;
            return;
        }
        const inc = incSnap.data();
        const ded = dedSnap.exists ? dedSnap.data() : {};
        const gross = inc.total_income;

        /* â”€â”€ Old Regime â”€â”€ */
        const std = 50000;
        const totalDed = Math.min((ded.section_80c||0), 150000)
                       + Math.min((ded.section_80d||0), 25000)
                       + (ded.section_80g||0)
                       + Math.min((ded.section_24||0), 200000)
                       + Math.min((ded.nps_80ccd||0), 50000)
                       + (ded.hra_exemption||0);
        const oldTaxable = Math.max(0, gross - std - totalDed);
        const oldTax     = calcOldTax(oldTaxable);

        /* â”€â”€ New Regime â”€â”€ */
        const newStd     = 75000;   // FY 2024-25
        const newTaxable = Math.max(0, gross - newStd);
        const newTax     = calcNewTax(newTaxable);

        const recommended = oldTax <= newTax ? 'old' : 'new';
        const saved       = Math.abs(oldTax - newTax);

        result.innerHTML = `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:10px;">
                <div style="padding:20px;border:2px solid ${recommended==='old'?'#4caf50':'#e0e0e0'};border-radius:12px;">
                    <h3 style="margin-bottom:12px;">Old Regime ${recommended==='old'?'âœ…':''}</h3>
                    <div class="metric-row"><span>Gross Income</span><span class="metric-val">${fmt(gross)}</span></div>
                    <div class="metric-row"><span>Total Deductions</span><span class="metric-val">${fmt(std+totalDed)}</span></div>
                    <div class="metric-row"><span>Taxable Income</span><span class="metric-val">${fmt(oldTaxable)}</span></div>
                    <div class="metric-row"><span>Total Tax + Cess</span><span class="metric-val" style="color:#e53935;">${fmt(oldTax)}</span></div>
                    <div class="metric-row"><span>Effective Rate</span><span class="metric-val">${gross?((oldTax/gross)*100).toFixed(2):0}%</span></div>
                    <div class="metric-row"><span>Post-Tax Income</span><span class="metric-val">${fmt(gross-oldTax)}</span></div>
                </div>
                <div style="padding:20px;border:2px solid ${recommended==='new'?'#4caf50':'#e0e0e0'};border-radius:12px;">
                    <h3 style="margin-bottom:12px;">New Regime ${recommended==='new'?'âœ…':''}</h3>
                    <div class="metric-row"><span>Gross Income</span><span class="metric-val">${fmt(gross)}</span></div>
                    <div class="metric-row"><span>Standard Deduction</span><span class="metric-val">${fmt(newStd)}</span></div>
                    <div class="metric-row"><span>Taxable Income</span><span class="metric-val">${fmt(newTaxable)}</span></div>
                    <div class="metric-row"><span>Total Tax + Cess</span><span class="metric-val" style="color:#e53935;">${fmt(newTax)}</span></div>
                    <div class="metric-row"><span>Effective Rate</span><span class="metric-val">${gross?((newTax/gross)*100).toFixed(2):0}%</span></div>
                    <div class="metric-row"><span>Post-Tax Income</span><span class="metric-val">${fmt(gross-newTax)}</span></div>
                </div>
            </div>
            <div style="margin-top:20px;padding:15px;background:#e8f5e9;border-radius:10px;border:1px solid #a5d6a7;">
                ğŸ’¡ <strong>Recommendation:</strong> Choose the <strong>${recommended.toUpperCase()} regime</strong>
                to save <strong>${fmt(saved)}</strong> in taxes this year.
            </div>`;
    } catch(e) {
        result.innerHTML = `<p style="color:#e53935;">Error: ${e.message}</p>`;
    }
}

function calcOldTax(inc) {
    let t = 0;
    if (inc <= 250000) t = 0;
    else if (inc <= 500000)  t = (inc-250000)*0.05;
    else if (inc <= 750000)  t = 12500+(inc-500000)*0.10;
    else if (inc <= 1000000) t = 37500+(inc-750000)*0.15;
    else if (inc <= 1250000) t = 75000+(inc-1000000)*0.20;
    else if (inc <= 1500000) t = 125000+(inc-1250000)*0.25;
    else                     t = 187500+(inc-1500000)*0.30;
    return Math.round(t * 1.04);   // +4% cess
}
function calcNewTax(inc) {
    let t = 0;
    if      (inc <= 300000)  t = 0;
    else if (inc <= 600000)  t = (inc-300000)*0.05;
    else if (inc <= 900000)  t = 15000+(inc-600000)*0.10;
    else if (inc <= 1200000) t = 45000+(inc-900000)*0.15;
    else if (inc <= 1500000) t = 90000+(inc-1200000)*0.20;
    else                     t = 150000+(inc-1500000)*0.30;
    // Rebate u/s 87A: if taxable â‰¤ 7 lakh, no tax in new regime
    if (inc <= 700000) t = 0;
    return Math.round(t * 1.04);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEALTH SCORE  (calculated from Firestore data)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function calcHealth() {
    const result = document.getElementById('healthResult');
    result.innerHTML = '<div class="loading">Analysing your financial dataâ€¦</div>';
    try {
        const [incSnap, expSnaps, savSnaps] = await Promise.all([
            userRef().collection('income').orderBy('financial_year','desc').limit(1).get(),
            userRef().collection('expenses').get(),
            userRef().collection('savings').get()
        ]);
        if (incSnap.empty) {
            result.innerHTML = '<p style="color:#999;">Add income data first.</p>'; return;
        }
        const inc      = incSnap.docs[0].data();
        const expenses = expSnaps.docs.map(d=>d.data());
        const savings  = savSnaps.docs.map(d=>d.data());

        const annualInc = inc.total_income;
        const avgExp    = expenses.length
            ? expenses.reduce((s,e)=>s+e.total_expenses,0)/expenses.length : 0;
        const totalSav  = savings.reduce((s,sv)=>s+sv.total_savings,0);
        const annualExp = avgExp * 12;

        const savRatio  = annualInc>0 ? (totalSav/annualInc)*100 : 0;
        const expRatio  = annualInc>0 ? (annualExp/annualInc)*100 : 0;

        /* Score components */
        const savScore  = Math.min(40, savRatio * 2);           // max 40
        const expScore  = expRatio<=50 ? 40 : Math.max(0, 40-(expRatio-50)); // max 40
        const divScore  = savings.length>0 ? Math.min(20,
            [s=>s.fixed_deposits,s=>s.mutual_funds,s=>s.ppf,
             s=>s.stocks,s=>s.gold,s=>s.emergency_fund]
            .filter(fn=>savings.some(s=>fn(s)>0)).length * (20/6)) : 0;      // max 20

        const overall = Math.min(100, Math.round(savScore + expScore + divScore));
        const cat = overall>=80 ? 'ğŸŒŸ Excellent' : overall>=60 ? 'ğŸ˜Š Good'
                  : overall>=40 ? 'ğŸ˜ Fair' : 'âš ï¸ Needs Attention';
        const catColor = overall>=80 ? '#2e7d32' : overall>=60 ? '#1565c0'
                       : overall>=40 ? '#e65100' : '#c62828';

        result.innerHTML = `
            <div style="text-align:center;padding:20px 0;">
                <div style="font-size:80px;font-weight:800;color:#667eea;">${overall}</div>
                <div style="font-size:22px;font-weight:600;color:${catColor};margin-bottom:30px;">${cat}</div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:25px;">
                <div style="background:#f0f4ff;padding:20px;border-radius:12px;text-align:center;">
                    <div style="font-size:28px;font-weight:700;color:#667eea;">${savRatio.toFixed(1)}%</div>
                    <div style="color:#555;font-size:13px;margin-top:5px;">Savings Ratio<br><span style="color:${savRatio>=20?'#2e7d32':'#c62828'};font-size:12px;">${savRatio>=20?'âœ… Good (â‰¥20%)':'âš ï¸ Low (<20%)'}</span></div>
                </div>
                <div style="background:#f0f4ff;padding:20px;border-radius:12px;text-align:center;">
                    <div style="font-size:28px;font-weight:700;color:#667eea;">${expRatio.toFixed(1)}%</div>
                    <div style="color:#555;font-size:13px;margin-top:5px;">Expense Ratio<br><span style="color:${expRatio<=50?'#2e7d32':'#c62828'};font-size:12px;">${expRatio<=50?'âœ… Good (â‰¤50%)':'âš ï¸ High (>50%)'}</span></div>
                </div>
                <div style="background:#f0f4ff;padding:20px;border-radius:12px;text-align:center;">
                    <div style="font-size:28px;font-weight:700;color:#667eea;">${fmt(totalSav)}</div>
                    <div style="color:#555;font-size:13px;margin-top:5px;">Total Accumulated Savings</div>
                </div>
            </div>
            <div style="background:#e8f5e9;padding:20px;border-radius:12px;border:1px solid #a5d6a7;">
                <strong>ğŸ’¡ Recommendations:</strong><br>
                ${savRatio<20 ? 'â€¢ Increase savings â€” aim for â‰¥20% of income.<br>' : ''}
                ${expRatio>50 ? 'â€¢ Reduce monthly expenses â€” currently '+expRatio.toFixed(0)+'% of income.<br>' : ''}
                ${divScore<15 ? 'â€¢ Diversify investments: add stocks, mutual funds, or gold.<br>' : ''}
                ${overall>=80 ? 'â€¢ You\'re doing great! Stay consistent and review your portfolio annually.' : ''}
            </div>`;
    } catch(e) {
        result.innerHTML = `<p style="color:#e53935;">Error: ${e.message}</p>`;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI UTILITIES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(name, btn) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(name + 'Tab').classList.add('active');
}

/* number shorthand */
const num = id => parseFloat(document.getElementById(id)?.value) || 0;

/* format Indian rupees */
function fmt(n) {
    return 'â‚¹' + (n||0).toLocaleString('en-IN', { maximumFractionDigits: 0 });
}

/* toast notification */
let _toastTimer;
function toast(msg, err=false) {
    clearTimeout(_toastTimer);
    let t = document.getElementById('toast');
    if (!t) {
        t = document.createElement('div');
        t.id = 'toast';
        t.style.cssText = `position:fixed;bottom:30px;right:30px;padding:14px 22px;
            border-radius:12px;font-size:14px;font-weight:600;z-index:9999;
            box-shadow:0 8px 24px rgba(0,0,0,.2);transition:opacity .3s;`;
        document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.background = err ? '#f44336' : '#4caf50';
    t.style.color = 'white';
    t.style.opacity = '1';
    _toastTimer = setTimeout(() => t.style.opacity='0', 3000);
}
</script>

<!--
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  FIRESTORE SECURITY RULES â€” paste this in Firebase Console >
  Firestore > Rules tab
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Each user can only read/write their own subtree
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      match /income/{year} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /deductions/{year} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /expenses/{month} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /savings/{month} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  HOW TO ENABLE FIRESTORE IN FIREBASE CONSOLE:
  1. Go to https://console.firebase.google.com
  2. Select your project
  3. Click "Firestore Database" in the left sidebar
  4. Click "Create database"
  5. Choose "Start in test mode" (then apply the rules above)
  6. Select a region â†’ Done!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
</body>
</html>